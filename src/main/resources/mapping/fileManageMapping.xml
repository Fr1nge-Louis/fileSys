<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.lhs.filesys.mapper.FileManageMapper">
    <insert id="saveMyFile" parameterType="cn.lhs.filesys.entity.MyFile">
        INSERT INTO myfile (uploaderId,fileId,fileName,fileUrl,fileOriginName,fileFormats,fileSort,fileSize,uploadTime,downloadTimes,isShared)
        VALUES (#{uploaderId},#{fileId},#{fileName},#{fileUrl},#{fileOriginName},#{fileFormats},#{fileSort},#{fileSize},#{uploadTime},#{downloadTimes},#{isShared});
    </insert>

    <delete id="delMyFile" parameterType="java.util.Map" >
        DELETE FROM myfile WHERE uploaderId=#{uploaderId} AND fileUrl=#{fileUrl};
    </delete>

    <update id="modifyMyFile" parameterType="java.util.Map">
        UPDATE myfile SET fileName=#{fileName} WHERE uploaderId=#{uploaderId} AND fileUrl=#{fileUrl};
    </update>

    <!--user查询自己上传文件-->
    <select id="getMyOwnFile" parameterType="java.util.Map" resultType="cn.lhs.filesys.entity.MyFile">
        SELECT * FROM myfile WHERE uploaderId=#{uploaderId}
        <if test="fileName != null">AND fileName LIKE concat('%',#{fileName},'%')</if>
        <if test="fileSort != null">AND fileSort=#{fileSort}</if>
        <if test="isShared != null">AND isShared=#{isShared}</if>
        ORDER BY uploadTime ASC limit #{offset},#{rows};
    </select>

    <select id="getMyOwnFileNum" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT count(fileId) FROM myfile WHERE uploaderId=#{uploaderId}
        <if test="fileName != null">AND fileName LIKE concat('%',#{fileName},'%')</if>
        <if test="fileSort != null">AND fileSort=#{fileSort}</if>
        <if test="isShared != null">AND isShared=#{isShared}</if>;
    </select>
    <!--******************-->


    <!--下载文件时所用查询-->
    <select id="getSharedFile" parameterType="java.util.Map" resultType="cn.lhs.filesys.entity.MyFile">
        SELECT * FROM myfile WHERE isShared='1'
        <if test="fileName != null">AND fileName LIKE concat('%',#{fileName},'%')</if>
        <if test="fileSort != null">AND fileSort=#{fileSort}</if>
        ORDER BY uploadTime ASC limit #{offset},#{rows};
    </select>

    <select id="getSharedFileNum" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(fileId) FROM myfile WHERE isShared='1'
        <if test="fileName != null">AND fileName LIKE concat('%',#{fileName},'%')</if>
        <if test="fileSort != null">AND fileSort=#{fileSort}</if>;
    </select>
    <!--*****************-->



    <select id="getFileNum"  resultType="java.lang.Integer">
        SELECT count(fileId) FROM myfile;
    </select>

    <update id="addDownloadTimes" parameterType="java.util.Map">
        UPDATE myfile set downloadTimes = downloadTimes + 1
        WHERE uploaderId=#{uploaderId} AND fileId=#{fileId};
    </update>

    <update id="shareFile" parameterType="java.util.Map">
        UPDATE myfile SET isShared=#{isShared} WHERE uploaderId=#{uploaderId} AND fileUrl=#{fileUrl};
    </update>
</mapper>